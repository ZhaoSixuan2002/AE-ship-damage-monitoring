# 脚本重组方案

## 当前脚本分析

**核心工作流脚本:**
1. `batch_controller.py` - 批量调用Abaqus生成数据
2. `single_run.py` - 单次Abaqus运行（被batch_controller调用）
3. `postprocess_async.py` - 异步后处理（被batch_controller调用）
4. `preprocess_data.py` - 训练数据预处理
5. `preprocess_validate.py` - 验证数据预处理（包装器）
6. `train_model.py` - 模型训练
7. `eval_residuals_by_dimension.py` - 逐维阈值确定（非验证阶段）
8. `damage_validation.py` - 损伤识别验证
9. `time_history_animation.py` - 时历动画输出
10. `inp_to_vtu_with_elsets.py` - INP文件转VTU并提取元素集（渲染准备）
11. `view_damage_animation_interactive.py` - 交互式3D查看器（辅助工具）
12. `render_vtu_animation.py` - VTU 3D渲染动画

**待删除脚本（无用）:**
- `generate_animation_only.py`
- `analyze_crack_results.py`

---

## 重组后的脚本结构

**说明：**
- **主脚本后缀为 `_main`**：每个阶段的主脚本使用 `_main` 后缀
- **辅助脚本命名规则**：`{前缀数字}_{实际含义}_auxiliary.py`
  - 前缀使用对应流程数字（如 `01_`）
  - 中间用实际含义命名（如 `async_postprocess`）
  - 后缀统一为 `_auxiliary`
  - 示例：`01_async_postprocess_auxiliary.py`
- **分支工具后缀为 `_helper`**：不参与主流程的验证工具等使用 `_helper` 后缀
- **废弃 config.py 和 config_runtime.py**：参数按自然逻辑顺序直接在脚本中编写（可在对应位置简要注释）
- **废弃 utils/ 目录**：代码直接内嵌到各脚本
- **输出目录扁平化**：不建立子文件夹
- **待删除**：所有脚本重构完成后删除 `config.py`、`config_runtime.py` 等旧配置文件

```
script/
├── 01_generate_training_data_main.py
├── 01_async_postprocess_auxiliary.py         # 辅助：异步后处理等
├── 01_generate_training_data_output/
│   └── data_generation_log.txt               # 记录外部路径：C:/abaqus_gen_data
├── 
├── 02_inp_to_vtu_main.py                     # 提前：生成measures_ID_auto.csv供后续流程使用
├── 02_inp_to_vtu_output/
│   ├── whole_from_inp.vtu
│   ├── measures_ID_auto.csv                  # 重要：后续流程依赖此文件
│   └── element_sets_summary.txt
├── 
├── 03_preprocess_training_data_main.py
├── 03_preprocess_training_data_output/
│   ├── preprocessed_data_raw.npz
│   ├── preprocessed_data.npz
│   ├── transforms.joblib
│   ├── preprocess_V_first_25_combined_5x10.png
│   ├── preprocess_V_first_25_density_5x10.png
│   └── preprocess_V_first_25_scatter_5x10.png
├── 
├── 04_train_model_main.py
├── 04_train_model_output/
│   ├── autoencoder.pth
│   ├── training_losses.csv
│   ├── validation_indices.csv
│   ├── training_validation_loss.png
│   ├── training_validation_loss_log.png
│   └── reconstruction_multi_samples_5x5.png
├── 
├── 05_determine_thresholds_main.py
├── 05_determine_thresholds_output/
│   ├── dimension_thresholds.csv
│   ├── val_dim_stats.csv
│   ├── val_recon_errors.csv
│   └── val_tau_by_dimension.png
├── 
├── 06_generate_validation_data_main.py
├── 06_async_postprocess_auxiliary.py         # 辅助：异步后处理
├── 06_generate_validation_data_output/
│   └── data_generation_log.txt               # 记录外部路径：C:/abaqus_gen_data_validate_*
├── 
├── 07_preprocess_validation_data_main.py
├── 07_preprocess_validation_data_output/
│   ├── health_preprocessed_data_raw.npz
│   ├── health_preprocessed_data.npz
│   ├── health_preprocess_figures_*.png
│   ├── crack_preprocessed_data_raw.npz
│   ├── crack_preprocessed_data.npz
│   ├── crack_preprocess_figures_*.png
│   ├── corrosion_preprocessed_data_raw.npz
│   ├── corrosion_preprocessed_data.npz
│   └── corrosion_preprocess_figures_*.png
├── 
├── 08_damage_validation_main.py
├── 08_damage_validation_output/
│   ├── combined_residuals_crack.png
│   ├── combined_residuals_corrosion.png
│   ├── combined_residuals_health.png
│   ├── crack_detection_summary.png
│   ├── corrosion_detection_summary.png
│   └── health_detection_summary.png
├── 
├── 09_render_time_history_main.py
├── 09_render_time_history_output/
│   ├── opacity_animation.mp4
│   ├── opacity_data.csv
│   └── opacity_heatmap_3x3_samples.png       # 3x3子图大图
├── 
├── 10_render_vtu_animation_main.py
├── 10_render_vtu_animation_output/
│   ├── damage_suspicion_animation.gif
│   └── damage_suspicion_timeline.csv
├── 
└── 10_interactive_vtu_viewer_helper.py       # 分支工具：交互式VTU查看器（不参与主流程，辅助步骤10调整相机视角）
```

---

## 待删除文件和目录（重构完成后）

1. `config.py` - 废弃集中配置，待重构完成后删除
2. `config_runtime.py` - 废弃集中配置，待重构完成后删除
3. `utils/` - 废弃工具模块，代码内嵌到各脚本
4. `generate_animation_only.py` - 无用
5. `analyze_crack_results.py` - 无用
6. `single_run.py` - 整合到 01 辅助脚本
7. `postprocess_async.py` - 整合到 01 辅助脚本
8. `output/` - 废弃公共输出目录

---

## 执行顺序

```bash
# 数据生成阶段
python 01_generate_training_data_main.py

# 准备阶段（必须在预处理前执行，生成measures_ID_auto.csv）
python 02_inp_to_vtu_main.py

# 训练阶段
python 03_preprocess_training_data_main.py
python 04_train_model_main.py

# 阈值确定（方法研发）
python 05_determine_thresholds_main.py

# 验证阶段
python 06_generate_validation_data_main.py
python 07_preprocess_validation_data_main.py
python 08_damage_validation_main.py

# 可视化阶段
python 09_render_time_history_main.py
python 10_render_vtu_animation_main.py
python 10_interactive_vtu_viewer_helper.py --data crack           # 分支工具：调整相机视角（可选）
```

**说明：**
- `_main` 后缀的是主流程脚本，按顺序执行
- `_auxiliary` 后缀的辅助脚本会被主脚本自动调用，无需手动执行
  - 命名格式：`{前缀数字}_{实际含义}_auxiliary.py`
- `_helper` 后缀的是分支工具，不参与主流程，可选使用
- **重要**：步骤02必须在步骤03之前执行，因为步骤03依赖 `measures_ID_auto.csv` 文件

---

## 确认事项

✅ 主脚本使用 `_main` 后缀  
✅ 辅助脚本命名：`{前缀数字}_{实际含义}_auxiliary.py`（参与主流程，由主脚本调用）  
✅ 分支工具使用 `_helper` 后缀（不参与主流程）  
✅ 参数按自然逻辑顺序直接在脚本中编写，无需集中化配置  
✅ config.py 和 config_runtime.py 在所有脚本重构完成后删除  
✅ INP转VTU移到后面（09，渲染准备阶段）  
✅ 输出目录扁平化，不建立子文件夹  
✅ 时历动画输出包含3x3子图大图  
✅ 废弃 utils/ 目录，代码内嵌到各脚本
